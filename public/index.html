<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</title>
    
    <!-- é¿å… favicon 404 éŒ¯èª¤ -->
    <link rel="icon" href="data:,">
    
    <!-- å¤–éƒ¨CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    
    <!-- å…§åµŒåŸºæœ¬æ¨£å¼ (ç¢ºä¿å³ä½¿å¤–éƒ¨CSSåŠ è¼‰å¤±æ•—æˆ–è¢«ç§»é™¤ï¼Œä¹Ÿæœ‰åŸºæœ¬æ¡†æ¶) -->
    <style>
        body { background-color: #6f42c1; color: #333; font-family: sans-serif; padding-top: 20px; padding-bottom: 20px; }
        .main-container { max-width: 1200px; margin: auto; }
        .card-custom { background-color: white !important; border-radius: 10px !important; padding: 1.5rem !important; margin-bottom: 1.5rem !important; box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important; }
        .btn { cursor: pointer; }
        #editorContainer, #chatContainer, #aiResponse, #outputContent { border: 1px solid #ddd; border-radius: 5px; min-height: 100px;}
        #outputContent { background-color: #f8f9fa; padding: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;}
        
        /* æ•™å¸«å»£æ’­æ¨£å¼ */
        .teacher-broadcast {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.5s ease-out;
        }
        
        .broadcast-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            border-left: 5px solid #0056b3;
        }
        
        .broadcast-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            border-left: 5px solid #e0a800;
            color: #212529;
        }
        
        .broadcast-error {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border-left: 5px solid #b21f2d;
        }
        
        .broadcast-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border-left: 5px solid #155724;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .teacher-broadcast h5 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        
        .teacher-broadcast p {
            margin: 0;
            line-height: 1.4;
        }
        
        /* æ›´å¤šå¿…è¦çš„åŸºç¤æ¨£å¼å¯ä»¥åœ¨é€™è£¡æ·»åŠ ï¼Œä»¥æ¸›å°‘å°å¤–éƒ¨CSSæ–‡ä»¶çš„ä¾è³´ï¼Œä¸¦ç¢ºä¿JSæ§åˆ¶çš„æ¨£å¼æœ‰åŸºç¤ */
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center mb-4">
            <h1 class="text-white"><i class="fas fa-code-branch"></i> Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°</h1>
        </div>

        <div id="loginSection" class="card-custom p-4 mb-4">
            <h3 class="text-center mb-4"><i class="fas fa-users"></i> åŠ å…¥å”ä½œæˆ¿é–“</h3>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">æˆ¿é–“åç¨±</label>
                        <input type="text" class="form-control" id="roomInput" placeholder="è¼¸å…¥æˆ¿é–“åç¨±" value="test-room">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ‚¨çš„åç¨±</label>
                        <input type="text" class="form-control" id="nameInput" placeholder="è¼¸å…¥æ‚¨çš„åç¨±">
                    </div>
                    <button class="btn btn-primary w-100 mb-3" onclick="globalJoinRoom()"><i class="fas fa-sign-in-alt"></i> åŠ å…¥æˆ¿é–“</button>
                    <div class="text-center">
                        <hr class="my-3">
                        <p class="text-muted mb-2">æ•™å¸«å°ˆç”¨</p>
                        <button class="btn btn-outline-warning" onclick="openTeacherDashboard()"><i class="fas fa-chalkboard-teacher"></i> æ•™å¸«ç›£æ§å¾Œå°</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="workspaceSection" style="display: none;">
            <div class="card-custom p-3 mb-4">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0"><i class="fas fa-home"></i> æˆ¿é–“: <span id="currentRoom">-</span></h5>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-0 text-info"><i class="fas fa-user"></i> æˆ‘æ˜¯: <span id="currentUserName">-</span></h6>
                    </div>
                    <div class="col-md-3">
                        <div id="onlineUsers"><strong>åœ¨ç·šç”¨æˆ¶:</strong></div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge bg-success" id="connectionStatus">é€£æ¥ä¸­...</span>
                        <button class="btn btn-outline-danger btn-sm ms-2" onclick="globalLeaveRoom()">é›¢é–‹æˆ¿é–“</button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card-custom p-4" id="editorCard">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-code"></i> å”ä½œç·¨è¼¯å™¨</h5>
                            <div>
                                <!-- ç¬¬ä¸€çµ„ï¼šä¿å­˜ã€è¼‰å…¥ã€é‹è¡Œ -->
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="globalSaveCode()">
                                        <i class="fas fa-save"></i> ä¿å­˜
                                    </button>
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="saveDropdownBtn">
                                    <span class="visually-hidden">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu" id="saveCodeOptions">
                                    <li><h6 class="dropdown-header">ä¿å­˜åˆ°æ§½ä½</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(1)">
                                        <i class="fas fa-bookmark text-primary"></i> <span id="slot1Name">æ§½ä½ 1</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(2)">
                                        <i class="fas fa-bookmark text-success"></i> <span id="slot2Name">æ§½ä½ 2</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(3)">
                                        <i class="fas fa-bookmark text-warning"></i> <span id="slot3Name">æ§½ä½ 3</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalSaveToSlot(4)">
                                        <i class="fas fa-bookmark text-danger"></i> <span id="slot4Name">æ§½ä½ 4</span>
                                    </a></li>
                                </ul>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="globalLoadCode('latest')">
                                        <i class="fas fa-sync-alt"></i> è¼‰å…¥
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split" type="button" data-bs-toggle="dropdown" id="loadDropdownBtn">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu" id="loadCodeOptions">
                                        <li><h6 class="dropdown-header">è¼‰å…¥é¸é …</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalLoadCode('latest')">
                                            <i class="fas fa-sync-alt text-success"></i> è¼‰å…¥æœ€æ–°
                                        </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">æ§½ä½è¨˜éŒ„</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalLoadFromSlot(1)">
                                        <i class="fas fa-bookmark text-primary"></i> <span id="loadSlot1Name">æ§½ä½ 1</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalLoadFromSlot(2)">
                                        <i class="fas fa-bookmark text-success"></i> <span id="loadSlot2Name">æ§½ä½ 2</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalLoadFromSlot(3)">
                                        <i class="fas fa-bookmark text-warning"></i> <span id="loadSlot3Name">æ§½ä½ 3</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="globalLoadFromSlot(4)">
                                        <i class="fas fa-bookmark text-danger"></i> <span id="loadSlot4Name">æ§½ä½ 4</span>
                                    </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><h6 class="dropdown-header">æ­·å²ç‰ˆæœ¬</h6></li>
                                        <li id="historyEmptyMessage"><span class="dropdown-item-text text-muted">ç„¡æ­·å²ç‰ˆæœ¬</span></li>
                                    </ul>
                                    <button class="btn btn-outline-success btn-sm" onclick="globalRunCode()">
                                        <i class="fas fa-play"></i> é‹è¡Œ
                                    </button>
                                </div>
                                
                                <!-- ç¬¬äºŒçµ„ï¼šè¤‡è£½ -->
                                <div class="btn-group me-2" role="group">
                                    <button class="btn btn-primary btn-sm" onclick="globalCopyCode()">
                                        <i class="fas fa-copy"></i> è¤‡è£½
                                    </button>
                                </div>
                                
                                <!-- ç¬¬ä¸‰çµ„ï¼šæ›´å¤š(ä¸‹è¼‰ã€å°å…¥) -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="moreOptionsBtn">
                                        <i class="fas fa-ellipsis-h"></i> æ›´å¤š
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">æª”æ¡ˆæ“ä½œ</h6></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalDownloadCode()">
                                            <i class="fas fa-download text-primary"></i> ä¸‹è¼‰ .py æª”æ¡ˆ
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="globalImportCode()">
                                            <i class="fas fa-upload text-success"></i> å°å…¥æª”æ¡ˆ
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="editorContainer">
                            <textarea id="codeEditor"></textarea>
                            <input type="file" id="file-import" accept=".py,.txt" style="display: none;" onchange="globalHandleFileImport(event)">
                        </div>
                        <div id="codeOutput" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><i class="fas fa-terminal"></i> é‹è¡Œçµæœ</h6>
                                <button class="btn btn-outline-secondary btn-sm" onclick="globalClearOutput()"><i class="fas fa-times"></i> æ¸…é™¤</button>
                            </div>
                            <div id="outputContent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card-custom p-3 mb-3" id="panelCard">
                        <div class="d-flex justify-content-center mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" id="aiTabBtn" onclick="globalSwitchToAI()"><i class="fas fa-robot"></i> AIåŠ©æ•™</button>
                                <button type="button" class="btn btn-outline-success" id="chatTabBtn" onclick="globalSwitchToChat()"><i class="fas fa-comments"></i> èŠå¤©å®¤</button>
                            </div>
                        </div>
                        <div id="aiSection">
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-outline-info" onclick="globalAskAI('analyze')"><i class="fas fa-lightbulb"></i> è§£é‡‹ç¨‹å¼</button>
                                <button class="btn btn-outline-warning" onclick="globalAskAI('check_errors')"><i class="fas fa-bug"></i> æª¢æŸ¥éŒ¯èª¤</button>
                                <button class="btn btn-outline-success" onclick="globalAskAI('improvement_tips')"><i class="fas fa-lightbulb"></i> æ”¹é€²å»ºè­°</button>
                                <button class="btn btn-outline-dark" onclick="globalAskAI('run_code')"><i class="fas fa-play"></i> é‹è¡Œä»£ç¢¼</button>
                                <button class="btn btn-outline-danger" onclick="globalShowConflictSimulation()"><i class="fas fa-code-branch"></i> è¡çªæ¨¡æ“¬</button>
                                <button class="btn btn-outline-primary" onclick="globalShowTutorial()"><i class="fas fa-question-circle"></i> æ“ä½œæ•™å­¸</button>
                            </div>
                            <div id="aiResponse" class="p-2" style="min-height: 200px; background: #f8f9fa;"></div>
                            <div id="aiShareOptions" class="mt-2" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">åˆ†äº«åˆ°èŠå¤©å®¤?</small>
                                    <div>
                                        <button class="btn btn-success btn-sm" onclick="globalShareAIResponse()"><i class="fas fa-share"></i> åˆ†äº«</button>
                                        <button class="btn btn-secondary btn-sm" onclick="globalHideShareOptions()"><i class="fas fa-times"></i> å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="chatSection" style="display: none;">
                            <div id="chatContainer" class="p-2 mb-2" style="height: 300px; overflow-y: auto; background: #f8f9fa;"></div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="è¼¸å…¥æ¶ˆæ¯...">
                                <button class="btn btn-primary" onclick="globalSendChat()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å”ä½œæé†’ -->
        <div id="collaborationAlert" style="display: none; position: fixed; top: 20px; right: 20px; background-color: #fff3cd; color: #664d03; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba; z-index: 1050;">
            <div class="d-flex align-items-center"><i class="fas fa-exclamation-triangle text-warning me-2"></i><div><strong>âš ï¸ å…¶ä»–åŒå­¸ä¹Ÿåœ¨ä¿®æ”¹ç¨‹å¼ç¢¼ï¼</strong><div id="collaboratingUsers" class="mt-1"></div></div></div>
        </div>

        <!-- è¡çªè§£æ±ºæ¨¡æ…‹çª—å£ -->
        <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle"></i> å”ä½œè¡çª
                            <span id="conflictSeverity" class="badge bg-warning me-2">
                                <i class="fas fa-exclamation-triangle"></i> åˆ†æä¸­...
                            </span>
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <i class="fas fa-user-edit"></i>
                                    <strong><span id="conflictUserName">å…¶ä»–åŒå­¸</span></strong> ä¹Ÿåœ¨åŒæ™‚ä¿®æ”¹ç¨‹å¼ç¢¼
                                </div>
                                <button class="btn btn-sm btn-outline-warning" onclick="askAIForConflictHelp()">
                                    <i class="fas fa-robot"></i> è«‹AIå”åŠ©åˆ†æ
                                </button>
                            </div>
                        </div>
                        
                        <div id="diffSummary" class="alert alert-info">
                            æ­£åœ¨åˆ†æå·®ç•°...
                        </div>
                        
                        <!-- ä»£ç¢¼å·®ç•°å°æ¯”å€åŸŸ -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-code-branch"></i> ä»£ç¢¼å·®ç•°å°æ¯”
                                    </h6>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="ConflictResolver.copyToClipboard('myCodeVersion')">
                                            <i class="fas fa-copy"></i> è¤‡è£½æˆ‘çš„ç‰ˆæœ¬
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="ConflictResolver.copyToClipboard('otherCodeVersion')">
                                            <i class="fas fa-copy"></i> è¤‡è£½å°æ–¹ç‰ˆæœ¬
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="row g-0">
                                    <div class="col-md-6">
                                        <div class="bg-light p-2 border-end">
                                            <h6 class="text-primary mb-2">
                                                <i class="fas fa-user"></i> æ‚¨çš„ç‰ˆæœ¬
                                            </h6>
                                            <pre id="myCodeVersion" class="bg-white p-2 rounded border" style="max-height: 400px; overflow-y: auto;"></pre>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="bg-light p-2">
                                            <h6 class="text-warning mb-2">
                                                <i class="fas fa-users"></i> <span id="otherUserName">å°æ–¹</span>çš„ç‰ˆæœ¬
                                            </h6>
                                            <pre id="otherCodeVersion" class="bg-white p-2 rounded border" style="max-height: 400px; overflow-y: auto;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AIåˆ†æå€åŸŸ -->
                        <div id="conflictAIAnalysis" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-robot"></i> AI åˆ†æçµæœ
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="aiAnalysisContent">
                                        <!-- AIåˆ†æå…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="acceptChangesBtn">
                            <i class="fas fa-check"></i> æ¥å—æˆ‘çš„ä¿®æ”¹
                        </button>
                        <button type="button" class="btn btn-primary" id="rejectChangesBtn">
                            <i class="fas fa-sync"></i> æ¥å—å°æ–¹ä¿®æ”¹
                        </button>
                        <button type="button" class="btn btn-info" id="discussChangesBtn">
                            <i class="fas fa-comments"></i> åœ¨èŠå¤©å®¤è¨è«–
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> ç¨å¾Œè™•ç†
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- main-container end -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    
    <!-- æ¨¡çµ„åŒ–JSæª”æ¡ˆ (ç¢ºä¿è·¯å¾‘ç›¸å°æ–¼publicç›®éŒ„æ˜¯æ­£ç¢ºçš„) -->
    <script src="js/websocket.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/conflict.js"></script>
    <script src="js/save-load.js"></script>
    
    <script>
        // å…¨åŸŸäº‹ä»¶è™•ç†å‡½æ•¸ (é¿å…HTMLä¸­çš„onclickç›´æ¥èª¿ç”¨æ¨¡çµ„å…§éƒ¨æ–¹æ³•å°è‡´å¯èƒ½çš„åˆå§‹åŒ–é †åºå•é¡Œ)
        function globalJoinRoom() { if(UI) UI.joinRoom(); else console.error("UI not ready"); }
        function globalLeaveRoom() { if(UI) UI.leaveRoom(); else console.error("UI not ready"); }
        function globalLoadCode(loadType) { 
            console.log('ğŸ”„ å…¨åŸŸè¼‰å…¥å‡½æ•¸è¢«èª¿ç”¨:', loadType);
            if (window.SaveLoadManager) {
                if (loadType === 'latest') {
                    window.SaveLoadManager.loadFromLatest();
                } else {
                    window.SaveLoadManager.showLoadDialog();
                }
            } else {
                console.error('âŒ SaveLoadManager æœªåˆå§‹åŒ–');
                alert('è¼‰å…¥åŠŸèƒ½å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        function globalSaveCode() { 
            console.log('ğŸ’¾ å…¨åŸŸä¿å­˜å‡½æ•¸è¢«èª¿ç”¨');
            if (window.SaveLoadManager) {
                window.SaveLoadManager.saveCode();
            } else if (Editor) {
                // é™ç´šåˆ°ç·¨è¼¯å™¨çš„ä¿å­˜åŠŸèƒ½
                Editor.saveCode(); 
            } else {
                console.error('âŒ ä¿å­˜åŠŸèƒ½æœªæº–å‚™å¥½');
                alert('ä¿å­˜åŠŸèƒ½å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        function globalSaveToSlot(slotNumber) {
            console.log('ğŸ’¾ ä¿å­˜åˆ°æ§½ä½:', slotNumber);
            if (window.SaveLoadManager) {
                window.SaveLoadManager.saveToSlot(slotNumber);
            } else {
                console.error('âŒ SaveLoadManager æœªåˆå§‹åŒ–');
                alert('ä¿å­˜åŠŸèƒ½å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        function globalLoadFromSlot(slotNumber) {
            console.log('ğŸ“‚ å¾æ§½ä½è¼‰å…¥:', slotNumber);
            if (window.SaveLoadManager) {
                window.SaveLoadManager.loadFromSlot(slotNumber);
            } else {
                console.error('âŒ SaveLoadManager æœªåˆå§‹åŒ–');
                alert('è¼‰å…¥åŠŸèƒ½å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        function globalRunCode() { if(Editor) Editor.runCode(); else console.error("Editor not ready"); }
        function globalClearOutput() { if(Editor) Editor.clearOutput(); else console.error("Editor not ready"); }
        function globalSwitchToAI() { if(UI) UI.switchToAI(); else console.error("UI not ready"); }
        function globalSwitchToChat() { if(UI) UI.switchToChat(); else console.error("UI not ready"); }
        // AIç›¸é—œçš„å…¨åŸŸå‡½æ•¸ç¾åœ¨åœ¨ai-assistant.jsä¸­å®šç¾©
        function globalSendChat() { if(Chat) Chat.sendMessage(); else console.error("Chat not ready"); }
        function globalResolveConflict(action) { if(ConflictResolver) ConflictResolver.resolveConflict(action); else console.error("ConflictResolver not ready"); }
        // globalAskAIForConflictHelp å‡½æ•¸å·²ç§»åˆ° conflict.js ä¸­
        function globalTestConflictAnalysis() { 
            console.log('ğŸ§ª åŸ·è¡Œè¡çªåˆ†ææ¸¬è©¦');
            
            // é¡¯ç¤ºè¡çªåˆ†æé¸é …æ¨¡æ…‹æ¡†
            showConflictAnalysisOptions();
        }
        function globalOpenTeacherDashboard() { window.open('/teacher', '_blank'); }
        function globalShowTutorial() { if(UI) UI.showTutorial(); else console.error("UI not ready"); }
        
        // æ–°å¢çš„æª”æ¡ˆæ“ä½œåŠŸèƒ½
        function globalCopyCode() { if(Editor) Editor.copyCode(); else console.error("Editor not ready"); }
        function globalDownloadCode() { if(Editor) Editor.downloadCode(); else console.error("Editor not ready"); }
        function globalImportCode() { if(Editor) Editor.importCode(); else console.error("Editor not ready"); }
        function globalHandleFileImport(event) { if(Editor) Editor.handleFileImport(event); else console.error("Editor not ready"); }

        // é¡¯ç¤ºè¡çªæ¨¡æ“¬é¸é …
        function globalShowConflictSimulation() {
            const modalHTML = `
                <div class="modal fade" id="conflictSimulationModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-code-branch"></i> è¡çªæ¨¡æ“¬åˆ†æ
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    é¸æ“‡ä¸€å€‹æ“ä½œï¼ŒAI å°‡åˆ†æå¯èƒ½ç”¢ç”Ÿçš„è¡çªä¸¦æä¾›å»ºè­°ã€‚
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-file-import text-primary"></i> 
                                                    å°å…¥æ“ä½œ
                                                </h6>
                                                <p class="card-text small text-muted">
                                                    æ¨¡æ“¬å°å…¥æ–°æª”æ¡ˆå¯èƒ½é€ æˆçš„è¡çª
                                                </p>
                                                <button class="btn btn-outline-primary btn-sm w-100" 
                                                    onclick="simulateConflict('import')">
                                                    <i class="fas fa-play"></i> æ¨¡æ“¬å°å…¥
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-sync-alt text-success"></i> 
                                                    è¼‰å…¥æ“ä½œ
                                                </h6>
                                                <p class="card-text small text-muted">
                                                    æ¨¡æ“¬è¼‰å…¥å…¶ä»–ç‰ˆæœ¬å¯èƒ½é€ æˆçš„è¡çª
                                                </p>
                                                <button class="btn btn-outline-success btn-sm w-100" 
                                                    onclick="simulateConflict('load')">
                                                    <i class="fas fa-play"></i> æ¨¡æ“¬è¼‰å…¥
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-users text-warning"></i> 
                                                    å¤šäººç·¨è¼¯
                                                </h6>
                                                <p class="card-text small text-muted">
                                                    æ¨¡æ“¬å¤šäººåŒæ™‚ç·¨è¼¯çš„è¡çªæƒ…æ³
                                                </p>
                                                <button class="btn btn-outline-warning btn-sm w-100" 
                                                    onclick="simulateConflict('concurrent')">
                                                    <i class="fas fa-play"></i> æ¨¡æ“¬å¤šäººç·¨è¼¯
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-random text-info"></i> 
                                                    è‡ªå®šç¾©æ¨¡æ“¬
                                                </h6>
                                                <p class="card-text small text-muted">
                                                    è‡ªå®šç¾©è¡çªå ´æ™¯é€²è¡Œæ¨¡æ“¬
                                                </p>
                                                <button class="btn btn-outline-info btn-sm w-100" 
                                                    onclick="simulateConflict('custom')">
                                                    <i class="fas fa-play"></i> è‡ªå®šç¾©æ¨¡æ“¬
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="simulationResult" class="mt-4" style="display: none;">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <i class="fas fa-robot"></i> AI åˆ†æçµæœ
                                        </div>
                                        <div class="card-body" id="aiAnalysisContent">
                                            <!-- AI åˆ†æçµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤èˆŠçš„æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingModal = document.getElementById('conflictSimulationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ–°çš„æ¨¡æ…‹æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            const modal = new bootstrap.Modal(document.getElementById('conflictSimulationModal'));
            modal.show();
        }

        // æ¨¡æ“¬è¡çª
        async function simulateConflict(type) {
            console.log('ğŸ”„ é–‹å§‹æ¨¡æ“¬è¡çª:', type);
            
            const currentCode = Editor.getCode();
            let simulationContext = {
                type: type,
                code: currentCode,
                user: wsManager.currentUser,
                room: wsManager.currentRoom
            };
            
            // æ ¹æ“šä¸åŒé¡å‹æ·»åŠ é¡å¤–ä¿¡æ¯
            switch(type) {
                case 'import':
                    simulationContext.operation = 'å°å…¥æ–°æª”æ¡ˆ';
                    simulationContext.scenario = 'ç•¶å…¶ä»–ç”¨æˆ¶æ­£åœ¨ç·¨è¼¯æ™‚å°å…¥æ–°æª”æ¡ˆ';
                    break;
                case 'load':
                    simulationContext.operation = 'è¼‰å…¥å…¶ä»–ç‰ˆæœ¬';
                    simulationContext.scenario = 'ç•¶å…¶ä»–ç”¨æˆ¶æ­£åœ¨ç·¨è¼¯æ™‚è¼‰å…¥æ­·å²ç‰ˆæœ¬';
                    break;
                case 'concurrent':
                    simulationContext.operation = 'å¤šäººåŒæ™‚ç·¨è¼¯';
                    simulationContext.scenario = 'å¤šå€‹ç”¨æˆ¶åŒæ™‚ä¿®æ”¹ç›¸åŒçš„ä»£ç¢¼å€åŸŸ';
                    break;
                case 'custom':
                    simulationContext.operation = 'è‡ªå®šç¾©å ´æ™¯';
                    simulationContext.scenario = 'ç”¨æˆ¶è‡ªå®šç¾©çš„è¡çªå ´æ™¯';
                    break;
            }
            
            try {
                // ç™¼é€åˆ°æœå‹™å™¨é€²è¡Œ AI åˆ†æ
                const message = {
                    type: 'ai_request',
                    action: 'simulate_conflict',
                    context: simulationContext
                };
                
                await wsManager.sendMessage(message);
                
                // é¡¯ç¤ºè¼‰å…¥ä¸­æç¤º
                document.getElementById('simulationResult').style.display = 'block';
                document.getElementById('aiAnalysisContent').innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">AI æ­£åœ¨åˆ†æå¯èƒ½çš„è¡çªæƒ…æ³...</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('âŒ æ¨¡æ“¬è«‹æ±‚å¤±æ•—:', error);
                UI.showErrorToast('æ¨¡æ“¬è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // DOMContentLoaded äº‹ä»¶è™•ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Pythonå¤šäººå”ä½œæ•™å­¸å¹³å°è¼‰å…¥å®Œæˆ');
            
            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡çµ„
            console.log('ğŸš€ åˆå§‹åŒ–æ‰€æœ‰æ¨¡çµ„...');
            
            // åˆå§‹åŒ–UIæ¨¡çµ„
            if (typeof UI !== 'undefined' && UI.initialize) {
                UI.initialize();
                console.log('âœ… UIæ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ UIæ¨¡çµ„åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–ç·¨è¼¯å™¨æ¨¡çµ„
            if (typeof Editor !== 'undefined' && Editor.initialize) {
                Editor.initialize();
                console.log('âœ… ç·¨è¼¯å™¨æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
                
                // ğŸ”§ é¡å¤–çš„ç·¨è¼¯å™¨æª¢æŸ¥å’Œä¿®å¾©
                setTimeout(() => {
                    if (window.Editor && window.Editor.editor) {
                        const cm = window.Editor.editor;
                        
                        // æª¢æŸ¥ç·¨è¼¯å™¨ç‹€æ…‹
                        console.log('ğŸ” ç·¨è¼¯å™¨ç‹€æ…‹æª¢æŸ¥:');
                        console.log('   - ç·¨è¼¯å™¨å­˜åœ¨:', !!cm);
                        console.log('   - åªè®€æ¨¡å¼:', cm.getOption('readOnly'));
                        console.log('   - å·²èšç„¦:', cm.hasFocus());
                        
                        // ç¢ºä¿ç·¨è¼¯å™¨å¯ä»¥è¼¸å…¥
                        cm.setOption('readOnly', false);
                        cm.refresh();
                        cm.focus();
                        
                        // æ¸¬è©¦è¼¸å…¥åŠŸèƒ½
                        cm.setValue('# æ­¡è¿ä½¿ç”¨ Python å”ä½œç·¨è¼¯å™¨\n# æ‚¨å¯ä»¥é–‹å§‹è¼¸å…¥ä»£ç¢¼...\n\n');
                        
                        console.log('âœ… ç·¨è¼¯å™¨å·²æº–å‚™å°±ç·’ï¼Œå¯ä»¥é–‹å§‹è¼¸å…¥');
                    } else {
                        console.error('âŒ ç·¨è¼¯å™¨å°è±¡ä¸å­˜åœ¨');
                    }
                }, 200);
            } else {
                console.error('âŒ ç·¨è¼¯å™¨æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–WebSocketç®¡ç†å™¨
            if (typeof window.wsManager !== 'undefined') {
                // WebSocketç®¡ç†å™¨å·²æº–å‚™å°±ç·’
                console.log('âœ… WebSocketç®¡ç†å™¨å·²æº–å‚™å°±ç·’');
            } else {
                console.error('âŒ WebSocketç®¡ç†å™¨æœªè¼‰å…¥');
            }
            
            // åˆå§‹åŒ–AIåŠ©æ•™
            if (typeof AIAssistant !== 'undefined' && AIAssistant.initialize) {
                AIAssistant.initialize();
                console.log('âœ… AIåŠ©æ•™æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ AIåŠ©æ•™æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—');
            }
            
            // åˆå§‹åŒ–èŠå¤©ç³»çµ±
            if (typeof Chat !== 'undefined' && Chat.initialize) {
                Chat.initialize();
                console.log('âœ… èŠå¤©ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.error('âŒ èŠå¤©ç³»çµ±åˆå§‹åŒ–å¤±æ•—');
            }
            
            console.log('âœ¨ æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ');
            
            // é è¨­é¡¯ç¤ºAIåŠ©æ•™
            if (typeof UI !== 'undefined' && UI.switchToAI) {
                UI.switchToAI();
                console.log('âœ… AIåŠ©æ•™å·²è¨­ç‚ºé è¨­é¡¯ç¤º');
            } else {
                console.error('âŒ ç„¡æ³•è¨­ç½®é è¨­ç•Œé¢ï¼ŒUIæœªå®šç¾©');
            }
        });
    </script>
</body>
</html> 