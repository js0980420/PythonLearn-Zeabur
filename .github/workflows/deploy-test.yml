name: ğŸš€ PythonLearn-Zeabur éƒ¨ç½²æ¸¬è©¦

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æ¸¬è©¦æ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - quick

env:
  NODE_VERSION: '18'
  MYSQL_HOST: ${{ secrets.MYSQL_HOST || 'localhost' }}
  MYSQL_USER: ${{ secrets.MYSQL_USER || 'root' }}
  MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD || '' }}
  MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE || 'python_collaboration' }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  # å¿«é€Ÿæª¢æŸ¥å·¥ä½œ
  quick-check:
    name: ğŸ“‹ å¿«é€Ÿæª¢æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.check.outputs.should-run }}
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§
      id: check
      run: |
        echo "ğŸ” æª¢æŸ¥å¿…è¦æª”æ¡ˆ..."
        
        required_files=(
          "server.js"
          "package.json"
          "public/index.html"
          "public/js/websocket.js"
          "public/js/ai-assistant.js"
          "deploy-test.js"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
          fi
        done
        
        if [[ ${#missing_files[@]} -gt 0 ]]; then
          echo "âŒ ç¼ºå°‘å¿…è¦æª”æ¡ˆ: ${missing_files[*]}"
          echo "should-run=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆéƒ½å­˜åœ¨"
        echo "should-run=true" >> $GITHUB_OUTPUT

  # å®Œæ•´éƒ¨ç½²æ¸¬è©¦
  deployment-test:
    name: ğŸ§ª å®Œæ•´éƒ¨ç½²æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: quick-check
    if: needs.quick-check.outputs.should-run-tests == 'true'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: python_collaboration
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: |
        echo "ğŸ“¦ å®‰è£ npm ä¾è³´..."
        npm ci
        
    - name: å®‰è£ Playwright
      run: |
        npm install @playwright/test
        npx playwright install chromium --with-deps
        
    - name: è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šæ•¸
      run: |
        echo "âš™ï¸ è¨­ç½®æ¸¬è©¦ç’°å¢ƒ..."
        echo "MYSQL_HOST=localhost" >> $GITHUB_ENV
        echo "MYSQL_USER=root" >> $GITHUB_ENV
        echo "MYSQL_PASSWORD=test_password" >> $GITHUB_ENV
        echo "MYSQL_DATABASE=python_collaboration" >> $GITHUB_ENV
        echo "NODE_ENV=test" >> $GITHUB_ENV
        echo "PORT=3001" >> $GITHUB_ENV
        
    - name: ç­‰å¾… MySQL å°±ç·’
      run: |
        echo "â³ ç­‰å¾… MySQL æœå‹™å•Ÿå‹•..."
        for i in {1..30}; do
          if mysqladmin ping -h"localhost" -P"3306" -u"root" -p"test_password" --silent; then
            echo "âœ… MySQL å·²å°±ç·’"
            break
          fi
          echo "ç­‰å¾…ä¸­... ($i/30)"
          sleep 2
        done
        
    - name: åŸ·è¡Œå®Œæ•´éƒ¨ç½²æ¸¬è©¦
      run: |
        echo "ğŸš€ åŸ·è¡Œéƒ¨ç½²æ¸¬è©¦è…³æœ¬..."
        chmod +x deploy-test.js
        node deploy-test.js
        
    - name: ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-test-report
        path: |
          deployment-test-report.json
          test-results/
        retention-days: 7

  # æ¸¬è©¦çµæœåŒ¯ç¸½
  test-summary:
    name: ğŸ“Š æ¸¬è©¦çµæœåŒ¯ç¸½
    runs-on: ubuntu-latest
    needs: [quick-check, deployment-test]
    if: always() && needs.quick-check.outputs.should-run-tests == 'true'
    
    steps:        
    - name: ç”Ÿæˆæ¸¬è©¦åŒ¯ç¸½
      run: |
        echo "ğŸ“Š ç”Ÿæˆæ¸¬è©¦çµæœåŒ¯ç¸½..."
        
        if [[ "${{ needs.deployment-test.result }}" == "success" ]]; then
          echo "ğŸ‰ **æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†ï¼å¹³å°å·²æº–å‚™å¥½éƒ¨ç½²åˆ° Zeaburã€‚**"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²æª¢æŸ¥æ¸…å–®ï¼š"
          echo "   âœ… Node.js æ‡‰ç”¨ç¨‹åºæ­£å¸¸é‹è¡Œ"
          echo "   âœ… WebSocket é€£æ¥æ­£å¸¸"
          echo "   âœ… MySQL æ•¸æ“šåº«å…¼å®¹"
          echo "   âœ… Playwright å‰ç«¯æ¸¬è©¦é€šé"
          echo "   âœ… AI åŠ©æ•™é›†æˆå°±ç·’"
          echo ""
          echo "ğŸ”— å¯ä»¥é–‹å§‹éƒ¨ç½²åˆ° Zeabur äº†ï¼"
        else
          echo "âš ï¸ **æ¸¬è©¦å¤±æ•—ï¼Œå»ºè­°æª¢æŸ¥å¾Œå†éƒ¨ç½²ã€‚**"
          echo "è«‹æŸ¥çœ‹æ¸¬è©¦å ±å‘Šäº†è§£è©³æƒ…ã€‚"
        fi

  # éƒ¨ç½²å°±ç·’é€šçŸ¥
  deploy-ready:
    name: ğŸ¯ éƒ¨ç½²å°±ç·’é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deployment-test]
    if: needs.deployment-test.result == 'success' && github.ref == 'refs/heads/main'
    
    steps:
    - name: éƒ¨ç½²å°±ç·’é€šçŸ¥
      run: |
        echo "ğŸ‰ éƒ¨ç½²æ¸¬è©¦å®Œæˆï¼"
        echo "âœ… æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†"
        echo "ğŸš€ å¹³å°å·²æº–å‚™å¥½éƒ¨ç½²åˆ° Zeabur" 